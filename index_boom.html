<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">
    <link rel="shortcut icon" href="./favicon.ico">

    <title>鍛鍊時計</title>

    <!-- Bootstrap core CSS -->    
    <!-- <link href="./css/bootstrap.min.css" rel="stylesheet"> -->
	<link href="./css/bootstrap-theme.css" rel="stylesheet">	
	<link href="./css/coachTimer.css" rel="stylesheet"> 
	<link href="./css/jquery.share.css" rel="stylesheet">
	<link rel="stylesheet" type="text/css" href="./css/pietimer.css">	
	
	<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
	<script type="text/javascript" src="./js/jquery.easing.1.3.js"></script>
	<!--<script type="text/javascript" src="./js/jquery.share.js"></script>
	<script type="text/javascript" src="./js/bootstrap.js"></script> -->
	<script type="text/javascript" src="./js/jquery.pietimer.js"></script>
	<script type="text/javascript" src="http://www.parsecdn.com/js/parse-1.2.18.min.js"></script>	
	
	<script type="text/javascript"> //load Parse
    Parse.initialize("swtRMGFGKXZI4XTZ6MxMASTIhMV1ZArZhAX4A4fj", "dQgwEycp8c0qoTCAqtDbior2xsCnsMKbTaUSq69a");
	</script>
  
    <script>	//load FacebookSDK
      window.fbAsyncInit = function() {
        Parse.FacebookUtils.init({
          appId      : '449939898442125',
          //xfbml      : true,
          //version    : 'v2.0'
        });
      };

      (function(d, s, id){
         var js, fjs = d.getElementsByTagName(s)[0];
         if (d.getElementById(id)) {return;}
         js = d.createElement(s); js.id = id;
         js.src = "//connect.facebook.net/en_US/all.js";
         fjs.parentNode.insertBefore(js, fjs);
       }(document, 'script', 'facebook-jssdk'));
    </script>
  
	<script>
  
		var offset = new Date().getTimezoneOffset();
		console.log(offset);
		
		var sideTimer;
		var sidePattern="";
		var preLoadTimer;
	
		var sercondPerMinute=60;
		
		
		var Actions={};
			Actions["M"] = {name:"馬步",imgUrl:"",point:["步伐與肩同寬","","雙腳朝前，不外翻"]};
			Actions["A"] = {name:"弓步",imgUrl:"",point:["腰跨朝前","前腳朝正前方","後腳朝斜前方","後腿撐直","後腳內側撐地","收提下腹","雙手插腰　肩膀放鬆"]};
			Actions["T"] = {name:"伏虎式",imgUrl:"",point:[""]};
			Actions["L"] = {name:"獨立式",imgUrl:"",point:["身體不左右傾","膝蓋不外翻",""]};
			Actions["S"] = {name:"坐盤式",imgUrl:"",point:[""]};
			Actions["SH"] = {name:"虛步",imgUrl:"",point:[""]};
			
	   $(document).ready(function() {
			$('#counterBlock').hide();
			$('#subcribe').hide();
			
      });

		var CoinSound = new Audio("./audio/SuperMarioBrothers-Coin.mp3");
		var JumpSound = new Audio("./audio/SuperMarioBrothers-Jump.mp3");
		var ClearSound = new Audio("./audio/SuperMarioBrothers-StageCleared.mp3");
		var ActionSound;
		
		function hideTitle()
		{
			
		}	
			
		function Coachtimer(patternString)
		{
			//CoinSound.play();
			$('#title').fadeOut('slow');
			$('#buttonSet').fadeOut('slow');
			$('hr').fadeOut('slow',function()
			{
				$('#counterBlock').fadeIn('slow',function(){
				
				$('#mainMove').animate({opacity: 0}, 'slow', function() {
				   $(this).css("background-image", "url(./img/img_3.png)").animate({opacity: 1}, 'slow',function()
				   {
						$('#mainMove').animate({opacity: 0}, 'slow', function() {
						$(this).css("background-image", "url(./img/img_2.png)").animate({opacity: 1}, 'slow',function()
						{
							$('#mainMove').animate({opacity: 0}, 'slow', function() {
							$(this).css("background-image", "url(./img/img_1.png)").animate({opacity: 1}, 'slow',function()
							{
								$('#mainMove').animate({opacity: 0}, 'slow', function() {
								$(this).css("background-image", "url(./img/img_start.png)").animate({opacity: 1}, 'slow',function()
								{
									
										$('#mainMove').css({"background-image": " "});
										
										
											$('#timer').pietimer({
											timerSeconds: 5,
											color: '#939296',
											fill: false,
											showPercentage: false,
											callback: function() {
												//alert("yahoo, timer is done!");
												$('#timer').pietimer('reset');
												//doAction(patternString);
											}		
											});
											
											$('#timer').fadeIn('slow');							
											doAction(patternString);																			
																																										

								});
								});
							});
						});
				   });});	
				   });});
					
					
					
				});					
			});
			
							
		}
		
		function doAction(patternString)
		{	
			if(patternString!="")
			{
				clearInterval(sideTimer);
				var location = patternString.search(",");	
				if (location == -1)
					location=patternString.length;
					
				var Step = patternString.slice(0,location);
				patternString = patternString.slice(location+1);
				
					var name = Step.split("-")[0];
					var time = Step.split("-")[1];
					sidePattern = Step.split("-")[2];
					//debugger;

								
					$('#mainMove').css("background-image", "url(./img/img_"+name+".png)");
					$('#subcribe').show();
					
					//$('h2').html(Actions[name].name +" "+time);
					
					MoveAlarm(name);
					setTimeout(function()
					{
					
						$('#timer').pietimer('callback',function(){						
						
							
							GetCoin();						
							
							setTimeout(function()
							{
												
								doAction(patternString);								
								$('#subcribe').css({'background-image': 'url()'});					
							},1200);
							
						});
					
						$('#timer').pietimer('setTime',time*sercondPerMinute);
												
					
						if(sidePattern)
						{
							var partition = time*sercondPerMinute/sidePattern.length *1000;
						
							ChangeSide();
							sideTimer=setInterval(function(){ChangeSide()},partition);
						}else
						{
							$('#subcribe').css({'background-image': ''});					
						}
					
					
					
					
					
					},2000)
					
					
					
	
						
			}
			else
			{
				
				$('#mainMove').animate({opacity: 0}, 'slow', function() {
									$(this).css({'background-image': 'url(./img/img_finish.png)'})
									.animate({opacity: 1})}
									
									);
				$('#subcribe').fadeOut('slow');					
				$('#timer').fadeOut('slow');				
				
				ClearSound.play();
				Record();
				//document.getElementById("stageClear").play();							

			}
		}

		function GetCoin()
		{
			$('#coin').show().animate({top:"-=30px"}, 'slow', function() {$('#coin').hide().css('top', '-30px');});		
			//document.getElementById("Coin").play();		
			CoinSound.play();
		}
		
		function MoveAlarm(name)
		{	
			
			
			ActionSounds = new Audio ("http://translate.google.com/translate_tts?ie=utf-8&tl=zh-tw&q="+Actions[name].name);		
			ActionSounds.play();
			//setTimeout(function(){ActionSound.pause()},2000);
			
			//$("#ActionVoice").attr("src","http://translate.google.com/translate_tts?ie=utf-8&tl=zh-tw&q="+Actions[name].name);
			//document.getElementById("ActionVoice").play();						
			
			setTimeout(function()
			{
				//debugger;
				var ChangeSound = new Audio ("http://translate.google.com/translate_tts?ie=utf-8&tl=zh-tw&q=換");
				ChangeSound.play();
				//$("#ActionVoice").attr("src","http://translate.google.com/translate_tts?ie=utf-8&tl=zh-tw&q="+"換");
				//document.getElementById("ActionVoice").play();						
			}
			,1500)
		}
		
		function ChangeSide()
		{
			//debugger;
			//console.log(" changeSide -trigger");
			if(sidePattern!="")
			{
				if(sidePattern[0]=="l")
				{
					$('#subcribe').animate({top:"-=10"},'easeInOutBack',function() {
									$(this).animate({top:"+=10"},'easeOutBounce');
									$(this).css({'background-image': 'url(./img/img_Left.png)'})
									});		
					
				}
				else
				{
					$('#subcribe').animate({top:"-=10"},'easeInBack',function() {
									$(this).animate({top:"+=10"},'easeOutElastic');
									$(this).css({'background-image': 'url(./img/img_Right.png)'})
									});		
				}
				
				JumpSound.play();
				//document.getElementById("Jump").play();
				sidePattern = sidePattern.slice(1);			

			}						
		}
	
		function Record()
		{				

			FB.getLoginStatus(function(response) {
			if (response.status === 'connected') {
					messBox("已登入");
				
					AddRecord();
				
				
			} else if (response.status === 'not_authorized') {
					messBox("FB未授權");
					
					Parse.FacebookUtils.logIn(null, {
					success: function(user) {
				
						/*if (!user.existed()) {
							alert("User signed up and logged in through Facebook!");									
						}else 
						{
							alert("User logged in through Facebook!");					
						}
						*/
				
						messBox("Parse login sucess");
						AddRecord()
		
				
					},
					error: function(user, error) {					
						messBox("Parse login Fail");
					}
					});
					
			} else {
					messBox("未登入FB");																			
			}
			});
												
		}
		
		function AddRecord()
		{
		
						
						var user = Parse.User.current();												
						var Coin = Parse.Object.exted("Coin");
						
						var coin = new Coin();
						debugger;
						coin.set("user",user.id);
						coin.set("coinNum",0);
						
						var query = new Parse.Query(Coin);
						query.equalTo("user", user.id);
						query.first({
							success: function(userCoin) {
							messBox("取得User Coin數");												
							coin = userCoin;// userPosts contains all of the posts by the current user.							
						},
						error: function(coins,error)
						{
							messBox("error:" + error.description);							
						}												
						});						
						
						
						coin.set("coinNum",coin.get("coinNum")+6);						
						
						coin.save(null, {
						success: function(coin) {
						
							messBox("Add coin sucess");
							//console.log("");
							// Execute any logic that should take place after the object is saved.
							//alert('New object created with objectId: ' + record.id);
						},
						error: function(coin, error) {	
							messBox("Add coin fail:"+error.description);
							//alert('Failed to create new object, with error code: ' + error.description);
						}	
						});		
						
						
						
						
						var Record = Parse.Object.extend("StepsTraining");
						var record = new Record();
	
						record.set("user", user.id);						
	
						record.save(null, {
						success: function(record) {
						
							messBox("Add record sucess");
							//console.log("");
							// Execute any logic that should take place after the object is saved.
							//alert('New object created with objectId: ' + record.id);
						},
						error: function(record, error) {	
							messBox("Add record fail:"+error.description);
							//alert('Failed to create new object, with error code: ' + error.description);
						}	
						});		
		
		}
		
		function getUserCoin(user)
		{

		}
		
		function messBox(mess)
		{
			$("#messenge").html(mess).fadeIn('slow');							
			setTimeout(
			function()
			{
				$("#messenge").fadeOut('slow');					
				
			},1000
			);
		}
		
		function TEST()
		{
			Record();//messBox("wow");
		}
	
	</script>	
</head>
<body>  
<div id="wrapper">

<h2 id="title">鍛鍊時計</h2>

 <div id="counterBlock" >
	<img id="coin" src="./img/Coin.gif">
	<div id="timer"></div>
	<div id="mainMove"></div>
	<div id="subcribe"></div>
 </div>
 
 

 
 <div id="hint"></div>
 
 <hr></hr>
  
 <div id="buttonSet">
	<button type="button" class="btn btn-lg btn-primary" onclick="Coachtimer('M-2,A-2-lr,T-2-lrlr,L-2-lr,S-2-lr,SH-2-lr')"> 站樁計時 </button>
	<button type="button" class="btn btn-lg btn-primary" onclick="Coachtimer('M-0.1,A-0.1-lr,T-0.1-lrlr,L-0.1-lr,S-0.1-lr,SH-0.1-lr')"> 快速測試 </button>
	<button type="button" class="btn btn-lg btn-primary" onclick="TEST()"> test </button>
 </div>
 
 </div>
 
 <div id="messenge">
 XD
 </div>
 
 <div id="footer">
 
	presented by <a href="https://www.facebook.com/pine0113">G.I</a>
	
 </div>

</body>
</html>